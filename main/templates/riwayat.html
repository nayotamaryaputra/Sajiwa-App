{% extends 'base.html' %}

{% block content %}

<div class="text-center mb-12 pt-8 animate-fade-in-up">
    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-600 to-teal-700 text-white shadow-lg mb-6 rotate-[-6deg] hover:rotate-0 transition duration-500">
        <i class="fa-solid fa-clock-rotate-left text-2xl"></i>
    </div>
    <h1 class="text-4xl md:text-6xl font-black text-emerald-950 tracking-tight mb-4 leading-tight">
        Riwayat <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500">Aktivitas</span>
    </h1>
    <p class="text-emerald-900/60 font-medium text-lg max-w-2xl mx-auto">
        Rekam jejak operasional, transaksi keuangan, dan perolehan poin Anda.
    </p>
</div>

<div x-data="{ activeTab: 'jemput' }" class="max-w-5xl mx-auto mb-24 px-4 relative z-10">

    <div class="flex justify-center mb-10 sticky top-24 z-30">
        <div class="bg-white/80 backdrop-blur-xl p-1.5 rounded-2xl border border-emerald-900/10 inline-flex flex-wrap justify-center gap-2 shadow-[0_8px_30px_rgb(0,0,0,0.04)]">
            
            <button @click="activeTab = 'jemput'" 
                :class="activeTab === 'jemput' ? 'bg-emerald-800 text-white shadow-lg shadow-emerald-900/20' : 'text-emerald-900 hover:bg-emerald-50'"
                class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 flex items-center gap-2">
                <i class="fa-solid fa-truck-fast"></i> <span class="hidden sm:inline">Penjemputan</span>
            </button>
            
            <button @click="activeTab = 'transaksi'" 
                :class="activeTab === 'transaksi' ? 'bg-emerald-800 text-white shadow-lg shadow-emerald-900/20' : 'text-emerald-900 hover:bg-emerald-50'"
                class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 flex items-center gap-2">
                <i class="fa-solid fa-money-bill-wave"></i> <span class="hidden sm:inline">Transaksi</span>
            </button>

            {% if user.profilpengguna.peran != 'kurir' %}
            <button @click="activeTab = 'poin'" 
                :class="activeTab === 'poin' ? 'bg-emerald-800 text-white shadow-lg shadow-emerald-900/20' : 'text-emerald-900 hover:bg-emerald-50'"
                class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 flex items-center gap-2">
                <i class="fa-solid fa-star"></i> <span class="hidden sm:inline">Poin</span>
            </button>
            {% endif %}

        </div>
    </div>

    <div class="min-h-[400px] relative z-0 bg-white/40 backdrop-blur-md border border-white/40 shadow-lg rounded-3xl p-6 md:p-8">

        <div x-show="activeTab === 'jemput'" x-transition.opacity.duration.300ms>
            <div class="flex flex-col sm:flex-row items-center justify-between mb-8 border-b border-emerald-900/10 pb-4 gap-4">
                <div>
                    <h3 class="text-2xl font-black text-emerald-950">Log Penjemputan</h3>
                    <p class="text-emerald-900/50 text-sm">Status permintaan angkut sampah.</p>
                </div>
                <span class="text-xs font-bold bg-emerald-100 text-emerald-800 px-4 py-2 rounded-xl border border-emerald-200">
                    Total: {{ riwayat_jemput.count }}
                </span>
            </div>

            <div class="space-y-4">
                {% for item in riwayat_jemput %}
                <div class="bg-white p-5 rounded-[2rem] border border-emerald-900/5 shadow-sm hover:shadow-xl hover:border-emerald-500/30 transition duration-300 relative overflow-hidden group">
                    
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-5 relative z-10">
                        <div class="flex items-start gap-5 w-full">
                            <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shrink-0 shadow-inner
                                {% if item.status == 'selesai' %}bg-emerald-50 text-emerald-500
                                {% elif item.status == 'dijemput' %}bg-blue-50 text-blue-500
                                {% else %}bg-yellow-50 text-yellow-500{% endif %}">
                                <i class="fa-solid 
                                    {% if item.jenis_sampah == 'plastik' %}fa-bottle-water
                                    {% elif item.jenis_sampah == 'kertas' %}fa-scroll
                                    {% elif item.jenis_sampah == 'logam' %}fa-screwdriver-wrench
                                    {% else %}fa-box-open{% endif %}"></i>
                            </div>

                            <div class="space-y-1 flex-grow">
                                <div class="flex flex-wrap items-center gap-2 mb-1">
                                    <h4 class="text-emerald-950 font-bold text-lg">{{ item.get_jenis_sampah_display }}</h4>
                                    
                                    {% if item.status == 'selesai' %}
                                        <span class="text-[10px] font-bold bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-md border border-emerald-200 uppercase tracking-wide">Selesai</span>
                                    {% elif item.status == 'dijemput' %}
                                        <span class="text-[10px] font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded-md border border-blue-200 uppercase tracking-wide">Proses</span>
                                    {% else %}
                                        <span class="text-[10px] font-bold bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-md border border-yellow-200 uppercase tracking-wide">Menunggu</span>
                                    {% endif %}
                                </div>
                                
                                <p class="text-sm text-emerald-900/60 font-medium">
                                    <i class="fa-regular fa-calendar mr-1"></i> {{ item.created_at|date:"d M Y" }} 
                                    {% if user.profilpengguna.peran == 'admin_sajiwa' %}
                                        <span class="text-emerald-300 mx-2">|</span> <i class="fa-solid fa-user mr-1"></i> <span class="text-emerald-700">{{ item.pemohon.username }}</span>
                                    {% endif %}
                                </p>
                                
                                <p class="text-xs text-emerald-900/40">
                                    <i class="fa-solid fa-location-dot mr-1"></i> {{ item.alamat.area.nama_jalan }}
                                </p>
                            </div>
                        </div>

                        <div class="w-full md:w-auto text-left md:text-right pl-[5.25rem] md:pl-0">
                            {% if item.status == 'selesai' %}
                                <p class="text-[10px] text-emerald-900/40 font-bold uppercase tracking-wider mb-1">Berat</p>
                                <p class="text-3xl font-black text-emerald-600 leading-none">{{ item.berat_real }} <span class="text-sm font-bold text-emerald-900/40">Kg</span></p>
                            {% else %}
                                <span class="text-xs font-medium text-emerald-900/40 italic bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">Belum ditimbang</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="py-16 text-center bg-white rounded-[2rem] border-2 border-dashed border-emerald-900/10">
                    <div class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-300">
                        <i class="fa-solid fa-box-open text-2xl"></i>
                    </div>
                    <p class="text-emerald-900/40 font-bold">Belum ada riwayat penjemputan.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div x-show="activeTab === 'transaksi'" x-transition.opacity.duration.300ms>
            <div class="flex flex-col sm:flex-row items-center justify-between mb-8 border-b border-emerald-900/10 pb-4 gap-4">
                <div>
                    <h3 class="text-2xl font-black text-emerald-950">Mutasi Keuangan</h3>
                    <p class="text-emerald-900/50 text-sm">Riwayat saldo masuk dan keluar.</p>
                </div>
                {% if user.profilpengguna.peran != 'admin_sajiwa' %}
                <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white px-5 py-2 rounded-xl shadow-lg shadow-emerald-600/20">
                    <p class="text-[10px] font-bold uppercase opacity-80">Saldo Anda</p>
                    <p class="text-xl font-bold">Rp {{ user.profilpengguna.poin }}</p>
                </div>
                {% endif %}
            </div>

            <div class="space-y-3">
                {% for t in riwayat_transaksi %}
                <div class="bg-white p-5 rounded-2xl flex items-center justify-between border border-emerald-900/5 hover:border-emerald-500/20 hover:shadow-md transition group">
                    <div class="flex items-center gap-5">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-lg shrink-0 transition-transform group-hover:scale-110
                            {% if t.tipe == 'masuk' %}bg-emerald-50 text-emerald-500 border border-emerald-100
                            {% else %}bg-rose-50 text-rose-500 border border-rose-100{% endif %}">
                            <i class="fa-solid {% if t.tipe == 'masuk' %}fa-arrow-down{% else %}fa-arrow-up{% endif %} transform {% if t.tipe == 'keluar' %}rotate-45{% endif %}"></i>
                        </div>
                        <div>
                            <h4 class="text-emerald-950 font-bold text-base mb-1">{{ t.keterangan }}</h4>
                            <p class="text-xs text-emerald-900/50 font-medium">
                                {{ t.tanggal|date:"d M Y • H:i" }} 
                                {% if user.profilpengguna.peran == 'admin_sajiwa' %}
                                    <span class="mx-1 text-gray-300">|</span> <span class="text-emerald-600 font-bold">{{ t.user.username }}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-lg font-black block {% if t.tipe == 'masuk' %}text-emerald-600{% else %}text-rose-500{% endif %}">
                            {% if t.tipe == 'masuk' %}+{% else %}-{% endif %} Rp {{ t.jumlah }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="py-16 text-center bg-white rounded-[2rem] border-2 border-dashed border-emerald-900/10">
                    <div class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-300">
                        <i class="fa-solid fa-receipt text-2xl"></i>
                    </div>
                    <p class="text-emerald-900/40 font-bold">Belum ada transaksi tercatat.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        {% if user.profilpengguna.peran != 'kurir' %}
        <div x-show="activeTab === 'poin'" x-transition.opacity.duration.300ms>
            
            {% if user.profilpengguna.peran == 'admin_sajiwa' %}
                <div class="mb-8 border-b border-emerald-900/10 pb-4">
                    <h3 class="text-2xl font-black text-emerald-950">Klasemen Poin Warga</h3>
                    <p class="text-emerald-900/50 text-sm">Peringkat warga berdasarkan kontribusi.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for w in data_poin_warga %}
                    <div class="bg-white p-5 rounded-2xl flex items-center justify-between border border-emerald-900/5 hover:border-yellow-400 hover:shadow-lg transition relative overflow-hidden group">
                        
                        {% if forloop.counter <= 3 %}
                        <div class="absolute -right-4 -top-4 w-16 h-16 bg-yellow-400/10 rounded-full blur-xl group-hover:bg-yellow-400/30 transition"></div>
                        {% endif %}

                        <div class="flex items-center gap-4 relative z-10">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-lg shadow-md border-2
                                {% if forloop.counter == 1 %}bg-yellow-400 text-yellow-900 border-yellow-200
                                {% elif forloop.counter == 2 %}bg-gray-300 text-gray-800 border-gray-100
                                {% elif forloop.counter == 3 %}bg-orange-300 text-orange-900 border-orange-200
                                {% else %}bg-emerald-50 text-emerald-700 border-emerald-100{% endif %}">
                                {{ forloop.counter }}
                            </div>
                            <div>
                                <h4 class="text-emerald-950 font-bold text-base">{{ w.user.username }}</h4>
                                <p class="text-xs text-emerald-900/40">{{ w.no_hp|default:"-" }}</p>
                            </div>
                        </div>
                        <div class="text-right relative z-10">
                            <span class="text-2xl font-black text-emerald-600 block">{{ w.poin }}</span>
                            <span class="text-[10px] text-emerald-900/40 uppercase font-bold tracking-wider">Total XP</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-span-full py-16 text-center bg-white rounded-[2rem] border-2 border-dashed border-emerald-900/10">
                        <p class="text-emerald-900/40 font-bold">Belum ada data warga.</p>
                    </div>
                    {% endfor %}
                </div>

            {% else %}
                <div class="flex flex-col sm:flex-row items-center justify-between mb-8 border-b border-emerald-900/10 pb-4 gap-4">
                    <div>
                        <h3 class="text-2xl font-black text-emerald-950">Log Poin Masuk</h3>
                        <p class="text-emerald-900/50 text-sm">Reward Experience Points (XP) Anda.</p>
                    </div>
                    <span class="text-xs font-bold bg-yellow-100 text-yellow-700 px-4 py-2 rounded-xl border border-yellow-200 flex items-center gap-2">
                        <i class="fa-solid fa-star text-yellow-500"></i> Total: {{ user.profilpengguna.poin }} XP
                    </span>
                </div>

                <div class="space-y-4">
                    {% for item in data_poin_saya %}
                    <div class="bg-gradient-to-r from-white to-yellow-50/50 border border-emerald-900/5 p-5 rounded-2xl flex items-center justify-between hover:shadow-md transition">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-yellow-100 text-yellow-600 flex items-center justify-center text-xl border border-yellow-200">
                                <i class="fa-solid fa-star"></i>
                            </div>
                            <div>
                                <h4 class="text-emerald-950 font-bold text-base">Selesai: {{ item.get_jenis_sampah_display }}</h4>
                                <p class="text-xs text-emerald-900/50 font-medium">{{ item.tanggal_jemput|date:"d M Y" }} • {{ item.berat_real }} Kg</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-black text-yellow-500">+10</span> 
                            <span class="text-[10px] text-yellow-700/60 font-bold uppercase block tracking-wider">XP Earned</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="py-16 text-center bg-white rounded-[2rem] border-2 border-dashed border-emerald-900/10">
                        <div class="w-16 h-16 bg-yellow-50 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-400">
                            <i class="fa-regular fa-star text-2xl"></i>
                        </div>
                        <p class="text-emerald-900/40 font-bold">Belum ada poin diperoleh.</p>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
            
        </div>
        {% endif %}

    </div>
</div>

{% endblock %}